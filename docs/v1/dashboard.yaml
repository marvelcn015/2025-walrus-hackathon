paths:
  /deals/{dealId}/dashboard:
    get:
      summary: Get comprehensive dashboard data for a deal
      description: |
        **Purpose**: Provide one-stop overview of deal status, progress, and health metrics

        **Business Logic**:
        - Aggregates data from multiple sources (Sui blockchain, Walrus metadata, local cache)
        - Shows period-by-period progress summary
        - Lists recent events and activities
        - Calculates health metrics and identifies risks
        - Suggests next actions based on user role and current status

        **Dashboard Components**:

        1. **Deal Info**: Basic deal details and user's role
        2. **Periods Summary**: Status of each earn-out period
           - Data upload progress (blob count, completeness)
           - KPI status (not proposed / proposed / approved / rejected)
           - Settlement status (not settled / pending / settled)
           - Payout amounts
        3. **Recent Events**: Timeline of important actions
           - Data uploads
           - KPI proposals and attestations
           - Settlements
           - Role updates
        4. **Health Metrics**: Overall deal health
           - Progress percentage
           - Pending actions requiring attention
           - Next deadlines
           - Risk detection (missing data, delays, etc.)

        **Sui Integration**:
        - Reads: Deal object, all Period objects
        - Events: Recent blockchain events (last 50 events)
        - Aggregation: Combines on-chain state with cached metadata
        - Caching: Dashboard data cached for 30 seconds

        **Walrus Integration**:
        - Metadata: Blob counts and last upload timestamps
        - Completeness: Calculates data completeness score per period

        **Role-Specific Views**:
        - **Buyer**: Sees upload progress, pending KPI proposals, settlement opportunities
        - **Seller**: Monitors buyer's data submissions, tracks expected payouts
        - **Auditor**: Sees pending KPI reviews, attestation queue

        **Use Cases**:
        - Landing page after selecting a deal
        - Quick health check without drilling into details
        - Identifying what actions are needed next
        - Monitoring overall earn-out progress

        **Access Control**:
        - Role: All deal participants (buyer, seller, auditor)
        - View: Customized based on user's role
      operationId: getDashboard
      tags:
        - Dashboard
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Deal ID
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved dashboard data
          content:
            application/json:
              schema:
                $ref: '../schemas/dashboard.yaml#/components/schemas/DashboardResponse'
              example:
                dealInfo:
                  dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                  name: "Acquisition of TechCorp Inc."
                  agreementDate: "2025-12-31"
                  currency: "USD"
                  status: "active"
                  roles:
                    buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                    auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                  userRole: "buyer"
                periodsSummary:
                  - periodId: "period_2026"
                    name: "2026 Fiscal Year"
                    dateRange:
                      start: "2026-01-01"
                      end: "2026-12-31"
                    dataUploadProgress:
                      blobCount: 5
                      lastUploadAt: "2026-12-28T10:30:00Z"
                      completeness: 100
                    kpiStatus: "approved"
                    kpiValue: 11300000
                    settlementStatus: "settled"
                    settlementAmount: 2600000
                    nextAction: null
                  - periodId: "period_2027"
                    name: "2027 Fiscal Year"
                    dateRange:
                      start: "2027-01-01"
                      end: "2027-12-31"
                    dataUploadProgress:
                      blobCount: 3
                      lastUploadAt: "2027-09-20T14:00:00Z"
                      completeness: 60
                    kpiStatus: "not_proposed"
                    settlementStatus: "not_settled"
                    nextAction:
                      action: "Continue uploading data"
                      actor: "buyer"
                      deadline: "2027-12-31"
                  - periodId: "period_2028"
                    name: "2028 Fiscal Year"
                    dateRange:
                      start: "2028-01-01"
                      end: "2028-12-31"
                    dataUploadProgress:
                      blobCount: 0
                      completeness: 0
                    kpiStatus: "not_proposed"
                    settlementStatus: "not_settled"
                    nextAction:
                      action: "Upload data (period not started)"
                      actor: "buyer"
                recentEvents:
                  - type: "settlement"
                    timestamp: "2027-02-15T14:30:00Z"
                    actor: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "buyer"
                    description: "Settled period_2026: $2,600,000 paid to seller"
                    txHash: "8vqKfZTqP9J3xYz1RmN2BcD4LpW7Qh5K"
                    metadata:
                      periodId: "period_2026"
                      amount: 2600000
                  - type: "kpi_attested"
                    timestamp: "2027-02-01T14:30:00Z"
                    actor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                    actorRole: "auditor"
                    description: "Auditor approved KPI for period_2026: Revenue = $11,300,000"
                    txHash: "9wqLfZUqP9K3xYz1RnN2BcE4MpX7Ri5L"
                    metadata:
                      periodId: "period_2026"
                      kpiType: "revenue"
                      value: 11300000
                  - type: "kpi_proposed"
                    timestamp: "2027-01-15T10:00:00Z"
                    actor: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "buyer"
                    description: "Buyer proposed KPI for period_2026: Revenue = $11,300,000"
                    txHash: "7vqKfZTqP9J3xYz1RmN2BcD4LpW7Qh5K"
                    metadata:
                      periodId: "period_2026"
                      kpiType: "revenue"
                      value: 11300000
                  - type: "data_upload"
                    timestamp: "2026-12-28T10:30:00Z"
                    actor: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "buyer"
                    description: "Uploaded ebitda_report for period_2026"
                    metadata:
                      periodId: "period_2026"
                      blobId: "blob_6Rj2uUd7Bq1Co9Vh3Az5Fg0Px8Lw"
                      dataType: "ebitda_report"
                  - type: "data_upload"
                    timestamp: "2026-12-20T16:00:00Z"
                    actor: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "buyer"
                    description: "Uploaded revenue_journal for period_2026"
                    metadata:
                      periodId: "period_2026"
                      blobId: "blob_5Qi1tTc6Ap0Bn8Ug2Zy4Ef9Ow7Kv"
                      dataType: "revenue_journal"
                healthMetrics:
                  overallProgress: 55.5
                  pendingActions: 2
                  nextDeadline: "2027-12-31"
                  dataCompletenessScore: 53.3
                  risksDetected:
                    - severity: "low"
                      category: "Missing Data"
                      description: "Period 2028 has no data uploads yet (period not started)"
                      periodId: "period_2028"
                    - severity: "medium"
                      category: "Incomplete Data"
                      description: "Period 2027 data completeness is 60% (recommended: 80%+)"
                      periodId: "period_2027"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User not a participant
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
