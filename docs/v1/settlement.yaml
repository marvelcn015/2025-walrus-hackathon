paths:
  /deals/{dealId}/periods/{periodId}/settle:
    post:
      summary: Execute settlement for a period
      description: |
        **Purpose**: Execute final earn-out payment after KPI is attested

        **Business Logic**:
        - Verifies KPI has been attested by auditor
        - Calculates final payout amount using attested KPI and on-chain formula
        - Creates settlement transaction that transfers funds to seller
        - Marks period as "settled" (irreversible)
        - Emits settlement event for audit trail

        **Settlement Flow**:
        1. Buyer confirms calculated payout amount
        2. System verifies amount matches on-chain formula calculation
        3. System creates settlement transaction:
           - Updates period status to "settled"
           - Records settlement timestamp and amount
           - Optionally transfers tokens from escrow to seller
        4. Buyer signs transaction with wallet
        5. Transaction executes on-chain
        6. Seller receives payout

        **Sui Integration**:
        - Writes: Calls `earnout::settle(deal, period)`
        - Transaction: Returns unsigned transaction for buyer to sign
        - Events: Emits `PeriodSettled` event with dealId, periodId, amount
        - State: Period.settlement updated with payout details
        - Transfer: Optionally transfers SUI or custom tokens from escrow
        - Gas: Estimated ~2,500,000 MIST

        **Token Transfer** (Optional for MVP):
        - In production: Transfer actual tokens (SUI, USDC, etc.) from escrow
        - For demo: Record settlement amount on-chain without token transfer
        - Escrow: Pre-funded treasury address controlled by buyer

        **Irreversibility Warning**:
        - Settlement is FINAL and cannot be reversed
        - Frontend must show clear warning before user signs
        - Amount must exactly match calculated payout
        - All validations happen before transaction creation

        **Access Control**:
        - Role: Buyer only
        - Verification: User address must match deal.buyer
        - Prerequisites:
          - KPI must be attested (status = "attested")
          - Period must not already be settled
          - Confirmed amount must match calculated amount
      operationId: settlePeriod
      tags:
        - Settlement
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Buyer's Sui address
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
        - name: periodId
          in: path
          required: true
          schema:
            type: string
          example: "period_2026"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/dashboard.yaml#/components/schemas/SettlementRequest'
            example:
              confirmedPayout: 2600000
      responses:
        '200':
          description: Settlement transaction ready
          content:
            application/json:
              schema:
                $ref: '../schemas/dashboard.yaml#/components/schemas/SettlementResponse'
              example:
                settlement:
                  periodId: "period_2026"
                  periodName: "2026 Fiscal Year"
                  attestedKPI: 11300000
                  calculatedPayout: 2600000
                  recipient: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                transaction:
                  txBytes: "AAACAAgA..."
                  description: "Settle period_2026: Pay $2,600,000 to seller"
                  warning: "This settlement is irreversible. Please verify the amount before signing."
                  estimatedGas: 2500000
                  tokenTransfer:
                    amount: 2600000
                    currency: "USD"
                    from: "0x_treasury_address"
                    to: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
              examples:
                amountMismatch:
                  value:
                    error: "ValidationError"
                    message: "Confirmed amount does not match calculated payout"
                    statusCode: 400
                    details:
                      confirmedAmount: 2500000
                      calculatedAmount: 2600000
                      difference: -100000
                kpiNotAttested:
                  value:
                    error: "ValidationError"
                    message: "Cannot settle period without attested KPI"
                    statusCode: 400
                    details:
                      kpiStatus: "proposed"
                      requiredStatus: "attested"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - Only buyer can settle
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal or period not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '409':
          description: Conflict - Period already settled
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ConflictError'
              example:
                error: "ConflictError"
                message: "Period already settled"
                statusCode: 409
                conflictReason: "Settlement was completed on 2027-02-15T14:30:00Z"
                details:
                  settledAt: "2027-02-15T14:30:00Z"
                  settledAmount: 2600000
                  txHash: "8vqKfZTqP9J3xYz1RmN2BcD4LpW7Qh5K"
