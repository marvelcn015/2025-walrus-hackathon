paths:
  /nautilus/calculate-kpi:
    post:
      summary: Calculate KPI using Nautilus TEE with cryptographic attestation
      description: |
        Trigger KPI calculation via Nautilus Trusted Execution Environment and return transaction for on-chain submission.

        Technical Flow:
        1. TEE retrieves encrypted financial documents from Walrus
        2. Decrypts documents inside secure enclave
        3. Computes KPI value based on uploaded data
        4. Generates cryptographic attestation (Ed25519 signature)
        5. Returns unsigned transaction for submitting KPI result on-chain

        Technical Highlights:
        - Verifiable computation: TEE signature proves calculation integrity
        - Data retrieved from Walrus decentralized storage
        - Calculation performed in isolated environment
        - Result includes 144-byte attestation for blockchain verification

        Access Control: Buyer only (seller and auditor cannot trigger calculation).

        Authentication: Requires signature headers (X-Sui-Signature) to prevent replay attacks.

      operationId: calculateKPI
      tags:
        - Nautilus
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the requester
        - name: X-Sui-Signature
          in: header
          required: true
          schema:
            type: string
          description: Base64-encoded signature of the timestamp message
        - name: X-Sui-Signature-Message
          in: header
          required: true
          schema:
            type: string
            format: date-time
          description: |
            ISO timestamp that was signed (e.g., "2025-11-20T10:30:45.123Z").
            Must be within 5 minutes to prevent replay attacks.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dealId
                - periodIndex
              properties:
                dealId:
                  type: string
                  pattern: '^0x[a-fA-F0-9]{64}$'
                  description: Deal ID to calculate KPI for
                periodIndex:
                  type: integer
                  minimum: 0
                  description: Zero-based index of the period
                kpiType:
                  type: string
                  enum: ["revenue", "ebitda", "user_growth", "arr", "custom"]
                  default: "revenue"
                  description: Type of KPI to calculate
            example:
              dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
              periodIndex: 0
              kpiType: "revenue"
      responses:
        '200':
          description: KPI calculation successful with TEE attestation
          content:
            application/json:
              schema:
                type: object
                required:
                  - kpiValue
                  - kpiType
                  - attestation
                  - computedAt
                  - nextStep
                properties:
                  kpiValue:
                    type: number
                    description: Calculated KPI value
                  kpiType:
                    type: string
                    description: Type of KPI calculated
                  attestation:
                    type: string
                    description: Base64-encoded cryptographic attestation from Nautilus TEE
                  computedAt:
                    type: integer
                    description: Unix timestamp when computation was performed
                  nextStep:
                    type: object
                    description: Transaction to submit KPI on-chain
                    properties:
                      action:
                        type: string
                        example: "submit_kpi_result"
                      description:
                        type: string
                        example: "Sign transaction to submit KPI result on-chain"
                      transaction:
                        type: object
                        properties:
                          txBytes:
                            type: string
                            description: Base64-encoded transaction bytes
                          description:
                            type: string
                            example: "Submit revenue KPI result: $12,500,000"
              example:
                kpiValue: 12500000
                kpiType: "revenue"
                attestation: "YXR0ZXN0YXRpb25fZGF0YV9oZXJl"
                computedAt: 1706184000
                nextStep:
                  action: "submit_kpi_result"
                  description: "Sign and execute transaction to submit KPI result on-chain"
                  transaction:
                    txBytes: "AAACAAgQJxAAAAAAAAAgx7VRE4..."
                    description: "Submit revenue KPI result: $12,500,000"
        '400':
          description: Invalid request parameters or insufficient data
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - Only buyer can trigger KPI calculation
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal or period not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Nautilus TEE communication or calculation error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'
