paths:
  /deals:
    get:
      summary: List all deals for current user
      description: |
        Retrieve paginated list of earn-out deals where the user is buyer, seller, or auditor.

        Queries Sui blockchain for Deal objects where user has a role, sorted by last activity.
        Results cached for 30 seconds for performance.

        Authentication: Level 1 (Read) - X-Sui-Address header only, no signature required.
      operationId: listDeals
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the user
          example: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
        - name: role
          in: query
          required: false
          schema:
            type: string
            enum: ["buyer", "seller", "auditor"]
          description: Filter by user's role in deals
          example: "buyer"
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: ["draft", "active", "completed", "cancelled"]
          description: Filter by deal status
          example: "active"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of deals to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of deals to skip
      responses:
        '200':
          description: Successfully retrieved deals list
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/DealListResponse'
              example:
                items:
                  - dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                    name: "Acquisition of TechCorp Inc."
                    agreementDate: "2025-12-31"
                    currency: "USD"
                    status: "active"
                    userRole: "buyer"
                    periodCount: 3
                    settledPeriods: 1
                    lastActivity: "2026-03-15T09:30:00Z"
                  - dealId: "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    name: "SaaS Platform Acquisition"
                    agreementDate: "2026-06-30"
                    currency: "USD"
                    status: "draft"
                    userRole: "auditor"
                    periodCount: 2
                    settledPeriods: 0
                    lastActivity: "2026-01-10T14:00:00Z"
                total: 2
                hasMore: false
                limit: 20
                offset: 0
        '401':
          description: Unauthorized - Invalid or missing authentication
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'

    post:
      summary: Create a new earn-out deal
      description: |
        Create a new M&A earn-out deal on Sui blockchain with role-based access control.

        Technical Flow:
        1. API builds unsigned transaction calling `earnout::create_deal()` Move function
        2. Returns transaction bytes to frontend
        3. User signs transaction in wallet
        4. Transaction executed on-chain with signature verification

        Technical Highlights:
        - On-chain Deal object created via Sui Move contract
        - Seal policy initialized for role-based encryption (buyer, seller, auditor)
        - DealCreated event emitted with dealId
        - Estimated gas: ~1,000,000 MIST

        Authentication: Level 2 (Write) - Returns unsigned transaction for wallet signing.
      operationId: createDeal
      tags:
        - Deal Management
      security:
        - Level2Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address (must be buyer)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/deal.yaml#/components/schemas/CreateDealRequest'
            example:
              name: "Acquisition of TechCorp Inc."
              agreementDate: "2025-12-31"
              currency: "USD"
              buyerAddress: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
              sellerAddress: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
              auditorAddress: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
              metadata:
                industry: "Technology"
                dealSize: "50M USD"
                notes: "Standard SaaS acquisition with 3-year earnout"
      responses:
        '201':
          description: Deal created successfully (transaction ready to sign)
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/CreateDealResponse'
              example:
                deal:
                  dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                  name: "Acquisition of TechCorp Inc."
                  agreementDate: "2025-12-31"
                  currency: "USD"
                  buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                  seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                  auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                  status: "draft"
                  periods: []
                  createdAt: "2025-11-16T10:00:00Z"
                  updatedAt: "2025-11-16T10:00:00Z"
                transaction:
                  txBytes: "AAACAAgA..."
                  description: "Create earn-out deal: Acquisition of TechCorp Inc."
                  estimatedGas: 1000000
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User is not buyer
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'

  /deals/{dealId}:
    get:
      summary: Get detailed information about a specific deal
      description: |
        Retrieve complete deal details including all periods, roles, and current status.

        Fetches Deal and Period objects from Sui blockchain. Results cached for 60 seconds.
        Backend verifies user is buyer, seller, or auditor (returns 403 if not).

        Authentication: Level 1 (Read) - X-Sui-Address header only, no signature required.
      operationId: getDeal
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved deal details
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/Deal'
              example:
                dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                name: "Acquisition of TechCorp Inc."
                agreementDate: "2025-12-31"
                currency: "USD"
                buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                status: "active"
                periods:
                  - periodId: "period_2026"
                    name: "2026 Fiscal Year"
                    startDate: "2026-01-01"
                    endDate: "2026-12-31"
                    status: "data_collection"
                createdAt: "2025-11-16T10:00:00Z"
                updatedAt: "2025-11-16T15:30:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User is not a participant in this deal
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'

  /deals/{dealId}/dashboard:
    get:
      summary: Get dashboard data for a specific deal
      description: |
        Comprehensive dashboard view including periods summary, health metrics, and recent events.

        Aggregates data from Sui blockchain Deal and Period objects, plus recent events for activity timeline.
        Results cached for 30 seconds.

        Response includes:
        - Deal info with user role
        - Periods summary with data upload progress, KPI status, settlement status
        - Recent on-chain events (KPI approvals, data uploads)
        - Health metrics and risk indicators

        Authentication: Level 1 (Read) - X-Sui-Address header only, no signature required.
      operationId: getDealDashboard
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved dashboard data
          content:
            application/json:
              schema:
                $ref: '../schemas/dashboard.yaml#/components/schemas/DashboardResponse'
              example:
                dealInfo:
                  dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                  name: "Acquisition of TechCorp Inc."
                  startDate: "2026-01-01"
                  closingDate: "2025-12-31"
                  currency: "USD"
                  status: "active"
                  roles:
                    buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                    auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                  userRole: "buyer"
                periodsSummary:
                  - periodId: "period_2026_01"
                    name: "January 2026"
                    periodIndex: 0
                    dateRange:
                      start: "2026-01-01"
                      end: "2026-01-31"
                    dataUploadProgress:
                      blobCount: 3
                      lastUploadAt: "2026-02-05T14:30:00Z"
                      completeness: 85
                    kpiStatus: "approved"
                    kpiValue: 1200000
                    settlementStatus: "settled"
                    settlementAmount: 500000
                  - periodId: "period_2026_02"
                    name: "February 2026"
                    periodIndex: 1
                    dateRange:
                      start: "2026-02-01"
                      end: "2026-02-28"
                    dataUploadProgress:
                      blobCount: 1
                      lastUploadAt: "2026-03-10T09:15:00Z"
                      completeness: 40
                    kpiStatus: "proposed"
                    kpiValue: 950000
                    settlementStatus: "pending"
                    nextAction:
                      action: "upload_missing_data"
                      actor: "seller"
                      deadline: "2026-03-31"
                recentEvents:
                  - type: "kpi_approved"
                    timestamp: "2026-02-10T16:00:00Z"
                    actor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                    actorRole: "auditor"
                    description: "Auditor approved KPI for January 2026"
                    txHash: "0xabc123def456..."
                  - type: "data_uploaded"
                    timestamp: "2026-02-05T14:30:00Z"
                    actor: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "seller"
                    description: "Seller uploaded revenue report for January 2026"
                healthMetrics:
                  overallProgress: 65
                  pendingActions: 2
                  nextDeadline: "2026-03-31"
                  dataCompletenessScore: 72
                  risksDetected:
                    - severity: "medium"
                      category: "data_completeness"
                      description: "February period missing expense reports"
                      periodId: "period_2026_02"
        '400':
          description: Invalid deal ID format
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '404':
          description: Deal not found or user is not a participant
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'

  /deals/{dealId}/blobs:
    get:
      summary: Get all Walrus blob references for a deal
      description: |
        Retrieve all encrypted financial documents (Walrus blobs) registered for a deal.

        Technical Flow:
        - Queries on-chain blob references from Sui Deal object
        - Fetches metadata from Walrus for each blob
        - Retrieves audit status from on-chain audit records
        - Returns combined data with blob IDs, metadata, and audit status

        Technical Highlight: Demonstrates Walrus + Sui integration - blob IDs registered on-chain for immutable proof.

        Authentication: None (should implement Level 1 auth in future).
      operationId: getDealBlobs
      tags:
        - Deals
      parameters:
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved blob references
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '../schemas/walrus.yaml#/components/schemas/BlobReference'
              example:
                - blobId: "blob_abc123"
                  dataType: "financial_report"
                  uploadedAt: "2026-02-05T14:30:00Z"
                  uploaderAddress: "0xabc..."
                  metadata:
                    filename: "revenue_report_jan_2026.pdf"
                    contentType: "application/pdf"
                    size: 524288
                  auditStatus:
                    audited: true
                    auditor: "0x987..."
                    auditTimestamp: "2026-02-10T16:00:00Z"
                - blobId: "blob_def456"
                  dataType: "expense_report"
                  uploadedAt: "2026-02-06T10:00:00Z"
                  uploaderAddress: "0xabc..."
                  metadata:
                    filename: "expenses_jan_2026.xlsx"
                    contentType: "application/vnd.ms-excel"
                    size: 102400
                  auditStatus:
                    audited: false
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'

  /deals/{dealId}/periods/{periodId}/blobs:
    get:
      summary: Get Walrus blob references for a specific period
      description: |
        Retrieve all encrypted financial documents for a specific period within a deal.

        Similar to /deals/{dealId}/blobs but filtered by period ID.
        Includes metadata from Walrus and audit status from on-chain records.

        Response includes download URLs for each blob.

        Authentication: None (should implement Level 1 auth in future).
      operationId: getPeriodBlobs
      tags:
        - Deals
      parameters:
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
        - name: periodId
          in: path
          required: true
          schema:
            type: string
          description: Period identifier (e.g., "2026-Q1", "period_2026_01")
          example: "2026-Q1"
      responses:
        '200':
          description: Successfully retrieved period blob references
          content:
            application/json:
              schema:
                type: object
                properties:
                  dealId:
                    type: string
                  periodId:
                    type: string
                  blobs:
                    type: array
                    items:
                      $ref: '../schemas/walrus.yaml#/components/schemas/BlobReference'
                  total:
                    type: integer
              example:
                dealId: "0x1234..."
                periodId: "2026-Q1"
                blobs:
                  - blobId: "blob_abc123"
                    dataType: "financial_report"
                    periodId: "2026-Q1"
                    uploadedAt: "2026-02-05T14:30:00Z"
                    uploaderAddress: "0xabc..."
                    metadata:
                      filename: "revenue_report_q1_2026.pdf"
                    size: 524288
                    downloadUrl: "/api/v1/walrus/download/blob_abc123?dealId=0x1234..."
                    auditStatus:
                      audited: true
                      auditor: "0x987..."
                total: 1
        '400':
          description: Validation error (invalid deal ID or missing period ID)
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '404':
          description: Deal or period not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'


