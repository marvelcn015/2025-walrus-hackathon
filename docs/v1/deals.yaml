paths:
  /deals:
    get:
      summary: List all deals for current user
      description: |
        **Purpose**: Retrieve all earn-out deals where the current user has a role (buyer, seller, or auditor)

        **Business Logic**:
        - Queries Sui blockchain for all deals where userAddress is buyer, seller, or auditor
        - Aggregates with off-chain metadata for faster response
        - Returns paginated list sorted by last activity
        - Includes summary statistics for each deal

        **Sui Integration**:
        - Reads: Queries Deal objects on Sui where user has role
        - Events: Reads recent events to determine last activity
        - Caching: Results cached for 30 seconds

        **Authentication**: Level 1 (Read)
        - Requires: `X-Sui-Address` header only
        - No signature required - provides frictionless browsing
        - Backend filters results to only show deals where user has a role
      operationId: listDeals
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address of the user
          example: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
        - name: role
          in: query
          required: false
          schema:
            type: string
            enum: ["buyer", "seller", "auditor"]
          description: Filter by user's role in deals
          example: "buyer"
        - name: status
          in: query
          required: false
          schema:
            type: string
            enum: ["draft", "active", "completed", "cancelled"]
          description: Filter by deal status
          example: "active"
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Maximum number of deals to return
        - name: offset
          in: query
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Number of deals to skip
      responses:
        '200':
          description: Successfully retrieved deals list
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/DealListResponse'
              example:
                items:
                  - dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                    name: "Acquisition of TechCorp Inc."
                    agreementDate: "2025-12-31"
                    currency: "USD"
                    status: "active"
                    userRole: "buyer"
                    periodCount: 3
                    settledPeriods: 1
                    lastActivity: "2026-03-15T09:30:00Z"
                  - dealId: "0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    name: "SaaS Platform Acquisition"
                    agreementDate: "2026-06-30"
                    currency: "USD"
                    status: "draft"
                    userRole: "auditor"
                    periodCount: 2
                    settledPeriods: 0
                    lastActivity: "2026-01-10T14:00:00Z"
                total: 2
                hasMore: false
                limit: 20
                offset: 0
        '401':
          description: Unauthorized - Invalid or missing authentication
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'

    post:
      summary: Create a new earn-out deal
      description: |
        **Purpose**: Create a new M&A earn-out deal on the Sui blockchain

        **Business Logic**:
        - Creates on-chain Deal object via Move contract
        - Stores metadata in local database for faster queries
        - Initializes empty periods array (periods added via parameters endpoint)
        - Returns unsigned transaction for user to sign with wallet

        **Sui Integration**:
        - Writes: Creates new Deal object via `earnout::create_deal()`
        - Transaction: Returns unsigned transaction for frontend to sign
        - Events: Emits `DealCreated` event on-chain with dealId
        - Gas: Estimated ~1,000,000 MIST

        **Seal Integration**:
        - Creates corresponding Seal policy for this deal
        - Initializes access control: buyer can read/write, seller/auditor can read

        **Authentication**: Level 2 (Write)
        - Requires: `X-Sui-Address` header only
        - API returns unsigned transaction bytes
        - User signs transaction in wallet (this is where authentication happens)
        - Transaction is executed on-chain with signature verification
        - Move contract enforces that sender is the buyer

        **Security Flow**:
        1. API validates address format and request data
        2. API builds unsigned transaction calling `earnout::create_deal()`
        3. Frontend receives transaction bytes
        4. User signs transaction in wallet
        5. Transaction executes on-chain - blockchain verifies signature
      operationId: createDeal
      tags:
        - Deal Management
      security:
        - Level2Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address (must be buyer)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '../schemas/deal.yaml#/components/schemas/CreateDealRequest'
            example:
              name: "Acquisition of TechCorp Inc."
              agreementDate: "2025-12-31"
              currency: "USD"
              buyerAddress: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
              sellerAddress: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
              auditorAddress: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
              metadata:
                industry: "Technology"
                dealSize: "50M USD"
                notes: "Standard SaaS acquisition with 3-year earnout"
      responses:
        '201':
          description: Deal created successfully (transaction ready to sign)
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/CreateDealResponse'
              example:
                deal:
                  dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                  name: "Acquisition of TechCorp Inc."
                  agreementDate: "2025-12-31"
                  currency: "USD"
                  buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                  seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                  auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                  status: "draft"
                  periods: []
                  createdAt: "2025-11-16T10:00:00Z"
                  updatedAt: "2025-11-16T10:00:00Z"
                transaction:
                  txBytes: "AAACAAgA..."
                  description: "Create earn-out deal: Acquisition of TechCorp Inc."
                  estimatedGas: 1000000
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User is not buyer
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'

  /deals/{dealId}:
    get:
      summary: Get detailed information about a specific deal
      description: |
        **Purpose**: Retrieve complete details of an earn-out deal

        **Business Logic**:
        - Fetches Deal object from Sui blockchain
        - Combines with off-chain metadata for enriched response
        - Includes all periods, roles, and current status
        - Verifies user has access to this deal

        **Sui Integration**:
        - Reads: Fetches Deal object by dealId
        - Reads: Fetches all Period objects for this deal
        - Events: Recent events for activity timeline
        - Caching: Cached for 60 seconds (invalidated on updates)

        **Authentication**: Level 1 (Read)
        - Requires: `X-Sui-Address` header only
        - No signature required
        - Backend verifies user is buyer, seller, or auditor of this deal
        - Returns 403 if user is not a participant
      operationId: getDeal
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved deal details
          content:
            application/json:
              schema:
                $ref: '../schemas/deal.yaml#/components/schemas/Deal'
              example:
                dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                name: "Acquisition of TechCorp Inc."
                agreementDate: "2025-12-31"
                currency: "USD"
                buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                status: "active"
                periods:
                  - periodId: "period_2026"
                    name: "2026 Fiscal Year"
                    startDate: "2026-01-01"
                    endDate: "2026-12-31"
                    status: "data_collection"
                createdAt: "2025-11-16T10:00:00Z"
                updatedAt: "2025-11-16T15:30:00Z"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '403':
          description: Forbidden - User is not a participant in this deal
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ForbiddenError'
        '404':
          description: Deal not found
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'

  /deals/{dealId}/dashboard:
    get:
      summary: Get dashboard data for a specific deal
      description: |
        **Purpose**: Get comprehensive dashboard view for a deal including periods summary, health metrics, and recent events

        **Business Logic**:
        - Aggregates deal information from Sui blockchain
        - Provides periods summary with data upload progress and KPI/settlement status
        - Provides health metrics and risk indicators
        - Shows recent activity timeline

        **Sui Integration**:
        - Reads: Deal object from blockchain
        - Reads: All Period objects for period-specific data
        - Events: Recent blockchain events for activity feed
        - Caching: Results cached for 30 seconds

        **Authentication**: Level 1 (Read)
        - Requires: `X-Sui-Address` header only
        - No signature required
        - Backend verifies user is buyer, seller, or auditor
        - Returns 404 if deal not found or user not authorized

        **Security**:
        - Address-only authentication (frictionless UX)
        - Backend filters by user role
        - All data served is from public blockchain (no secrets exposed)
      operationId: getDealDashboard
      tags:
        - Deal Management
      security:
        - Level1Auth: []
      parameters:
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui wallet address
        - name: dealId
          in: path
          required: true
          schema:
            type: string
            pattern: '^0x[a-fA-F0-9]{64}$'
          description: Sui object ID of the deal
          example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
      responses:
        '200':
          description: Successfully retrieved dashboard data
          content:
            application/json:
              schema:
                $ref: '../schemas/dashboard.yaml#/components/schemas/DashboardResponse'
              example:
                dealInfo:
                  dealId: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                  name: "Acquisition of TechCorp Inc."
                  startDate: "2026-01-01"
                  closingDate: "2025-12-31"
                  currency: "USD"
                  status: "active"
                  roles:
                    buyer: "0xabcd1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
                    seller: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                    auditor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                  userRole: "buyer"
                periodsSummary:
                  - periodId: "period_2026_01"
                    name: "January 2026"
                    periodIndex: 0
                    dateRange:
                      start: "2026-01-01"
                      end: "2026-01-31"
                    dataUploadProgress:
                      blobCount: 3
                      lastUploadAt: "2026-02-05T14:30:00Z"
                      completeness: 85
                    kpiStatus: "approved"
                    kpiValue: 1200000
                    settlementStatus: "settled"
                    settlementAmount: 500000
                  - periodId: "period_2026_02"
                    name: "February 2026"
                    periodIndex: 1
                    dateRange:
                      start: "2026-02-01"
                      end: "2026-02-28"
                    dataUploadProgress:
                      blobCount: 1
                      lastUploadAt: "2026-03-10T09:15:00Z"
                      completeness: 40
                    kpiStatus: "proposed"
                    kpiValue: 950000
                    settlementStatus: "pending"
                    nextAction:
                      action: "upload_missing_data"
                      actor: "seller"
                      deadline: "2026-03-31"
                recentEvents:
                  - type: "kpi_approved"
                    timestamp: "2026-02-10T16:00:00Z"
                    actor: "0x9876543210abcdef1234567890abcdef1234567890abcdef1234567890abcd"
                    actorRole: "auditor"
                    description: "Auditor approved KPI for January 2026"
                    txHash: "0xabc123def456..."
                  - type: "data_uploaded"
                    timestamp: "2026-02-05T14:30:00Z"
                    actor: "0xef012345678890abcdef1234567890abcdef1234567890abcdef1234567890"
                    actorRole: "seller"
                    description: "Seller uploaded revenue report for January 2026"
                healthMetrics:
                  overallProgress: 65
                  pendingActions: 2
                  nextDeadline: "2026-03-31"
                  dataCompletenessScore: 72
                  risksDetected:
                    - severity: "medium"
                      category: "data_completeness"
                      description: "February period missing expense reports"
                      periodId: "period_2026_02"
        '400':
          description: Invalid deal ID format
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/UnauthorizedError'
        '404':
          description: Deal not found or user is not a participant
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/NotFoundError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '../schemas/errors.yaml#/components/schemas/ErrorResponse'


