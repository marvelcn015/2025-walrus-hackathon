paths:
  /walrus/upload:
    post:
      summary: Upload encrypted file to Walrus decentralized storage
      description: |
        Upload financial documents to Walrus with Seal encryption and on-chain blob registration.

        Key Innovation - Upload Relay Pattern:
        - Direct browser uploads to Walrus require 2000+ HTTP requests per file
        - This relay reduces it to 1 API call, significantly improving UX
        - Backend handles Walrus SDK communication while maintaining security

        Encryption Modes (via `mode` query parameter):

        1. **client_encrypted** (Default, Recommended)
           - Frontend encrypts with Seal SDK before upload
           - Backend relays ciphertext to Walrus (never sees plaintext)
           - Zero-knowledge: Backend cannot access file contents

        2. **server_encrypted** (Convenience)
           - Frontend sends plaintext, backend encrypts with Seal
           - Simplified UX, requires trusting backend during upload
           - Frontend still decrypts on download

        Technical Flow:
        1. User selects file, frontend encrypts (or sends plaintext for server mode)
        2. Backend uploads to Walrus, returns blobId
        3. For real deals: Returns unsigned transaction to register blob on-chain
        4. Frontend signs transaction, creating immutable proof of data submission

        Walrus Integration Highlights:
        - Stores encrypted data on decentralized network (no single point of failure)
        - Blob IDs returned for on-chain registration via Sui Move contract
        - Access controlled by Seal policy on blockchain

        Authentication:
        - Pending deals (dealId="pending"): Level 1 (Read) - No transaction returned
        - Real deals (dealId=0x...): Level 2 (Write) - Returns unsigned transaction

      operationId: uploadToWalrus
      tags:
        - Walrus
      security:
        - Level2Auth: []
      parameters:
        - name: mode
          in: query
          required: false
          schema:
            type: string
            enum: [client_encrypted, server_encrypted]
            default: client_encrypted
          description: |
            client_encrypted: Frontend encrypted (most secure)
            server_encrypted: Backend encrypts (convenience mode)
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: "^0x[a-fA-F0-9]{64}$"
          description: Sui wallet address of uploader
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - dealId
                - periodId
                - dataType
              properties:
                file:
                  type: string
                  format: binary
                  description: |
                    File data: encrypted ciphertext (client mode) or plaintext (server mode)
                dealId:
                  type: string
                  description: |
                    "pending" for pre-deal uploads (Level 1 auth, no transaction)
                    Deal object ID (0x...) for financial docs (Level 2 auth, returns transaction)
                  example: "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"
                periodId:
                  type: string
                  description: Period identifier
                  example: "2026-Q1"
                dataType:
                  type: string
                  enum:
                    [
                      "revenue_journal",
                      "ebitda_report",
                      "expense_report",
                      "balance_sheet",
                      "cash_flow",
                      "kpi_calculation",
                      "audit_report",
                      "custom",
                    ]
                  description: Type of financial data
                customDataType:
                  type: string
                  description: Custom data type name (if dataType is 'custom')
                filename:
                  type: string
                  description: Original filename
                description:
                  type: string
                  maxLength: 500
                  description: File description
      responses:
        "200":
          description: |
            File uploaded to Walrus successfully.

            For real deals: includes unsigned transaction for on-chain blob registration.
            For pending deals: simple confirmation with blobId.
          content:
            application/json:
              schema:
                $ref: "../schemas/walrus.yaml#/components/schemas/WalrusUploadResponse"
              examples:
                realDealUpload:
                  summary: Real deal upload (with transaction for on-chain registration)
                  value:
                    blobId: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
                    commitment: "sha256:a1b2c3d4..."
                    size: 2048576
                    uploadedAt: "2026-03-15T09:30:00Z"
                    nextStep:
                      action: "register_on_chain"
                      description: "Sign transaction to register blob on-chain"
                      transaction:
                        txBytes: "AAACAAgA..."
                        description: "Register Walrus blob: revenue_journal for 2026-Q1"
                pendingDealUpload:
                  summary: Pending deal upload (no transaction)
                  value:
                    blobId: "blob_8Kf2pQz9..."
                    commitment: "sha256:f5e4d3c2..."
                    size: 201765
                    uploadedAt: "2025-11-23T10:15:00Z"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ValidationError"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/UnauthorizedError"
        "403":
          description: Forbidden - User not authorized for this deal
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ForbiddenError"
        "500":
          description: Walrus upload failed
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ErrorResponse"

  /walrus/download/{blobId}:
    get:
      summary: Download encrypted file from Walrus for client-side decryption
      description: |
        Download encrypted financial documents from Walrus decentralized storage.

        Technical Flow:
        1. Backend verifies user has role in deal (buyer/seller/auditor)
        2. Downloads encrypted blob from Walrus
        3. Returns ciphertext with Seal policy metadata in headers
        4. Frontend decrypts locally using Seal SDK

        Key Security Feature:
        - Backend never decrypts or accesses plaintext
        - Even if unauthorized user obtains ciphertext, cannot decrypt without proper role
        - Access control enforced by Seal whitelist on Sui blockchain

        Response Headers:
        - X-Seal-Package-Id: Seal package ID for decryption
        - X-Seal-Whitelist-Id: Whitelist object ID for access control
        - X-Original-Encryption-Mode: How file was encrypted (client/server)
        - X-Data-Type, X-Period-Id, X-Filename: Blob metadata

        Authentication: Level 1 (Read) - X-Sui-Address header only, no signature required.

      operationId: downloadFromWalrus
      tags:
        - Walrus
      security:
        - Level1Auth: []
      parameters:
        - name: blobId
          in: path
          required: true
          schema:
            type: string
          description: Walrus blob ID to download
          example: "blob_2Nf8pQz3Xm7Yk5Rd9Wv1Bc6Lt4Hs"
        - name: dealId
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[a-fA-F0-9]{64}$"
          description: Deal ID for authorization check
        - name: X-Sui-Address
          in: header
          required: true
          schema:
            type: string
            pattern: "^0x[a-fA-F0-9]{64}$"
          description: Sui wallet address requesting download
      responses:
        "200":
          description: Encrypted file downloaded successfully
          headers:
            X-Blob-Id:
              schema:
                type: string
              description: Walrus blob ID
            X-Original-Encryption-Mode:
              schema:
                type: string
                enum: [client_encrypted, server_encrypted]
              description: Original encryption mode used during upload
            X-Seal-Package-Id:
              schema:
                type: string
              description: Seal package ID for client-side decryption
            X-Seal-Whitelist-Id:
              schema:
                type: string
              description: Whitelist object ID for access control
            X-Data-Type:
              schema:
                type: string
              description: Data type (revenue_journal, etc.)
            X-Filename:
              schema:
                type: string
              description: Original filename
            Content-Type:
              schema:
                type: string
              description: File MIME type
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
              description: Encrypted binary data (requires Seal SDK to decrypt on frontend)
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ValidationError"
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/UnauthorizedError"
        "403":
          description: Forbidden - User not authorized to access this blob
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ForbiddenError"
        "404":
          description: Blob not found on Walrus network
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/NotFoundError"
        "500":
          description: Download failed
          content:
            application/json:
              schema:
                $ref: "../schemas/errors.yaml#/components/schemas/ErrorResponse"
